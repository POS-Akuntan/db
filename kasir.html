<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <title>Gudang - Kasirku</title>

    <!-- Bootstrap core CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.1/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.0/font/bootstrap-icons.css"
    />

    <!-- Custom styles for this template -->
    <link href="/static/css/pos.css" rel="stylesheet" />

    <style>
      #dt.dataTable.no-footer {
        border-bottom: unset;
      }
      #dt tbody td {
        display: block;
        border: unset;
      }
      #dt > tbody > tr > td {
        border-top: unset;
      }
      .dataTables_paginate {
        display: flex;
        align-items: center;
      }
      .dataTables_paginate a {
        padding: 0 10px;
      }
    </style>

    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js"></script>
  </head>

  <body>
    <div class="container">
      <header class="blog-header py-3">
        <div class="row flex-nowrap justify-content-between align-items-center">
          <div class="col-8">
            <a class="blog-header-logo text-dark" href="#">Kasirku</a>
          </div>
          <div class="col-4 d-flex justify-content-end align-items-center">
            <a class="btn btn-sm btn-outline-secondary" href="login.html"
              ><i class="bi bi-person-circle"></i> Masuk</a
            >
          </div>
        </div>
      </header>

      <div class="py-1 mb-4 border-bottom">
        <nav class="navbar navbar-expand-lg navbar-light bg-default">
          <div class="container-fluid">
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
              <div class="navbar-nav">
                <a class="p-2 nav-link" href="index.html"
                  ><i class="bi bi-house"></i> Home</a
                >
                <a class="p-2 nav-link" href="barang.html"
                  ><i class="bi bi-basket"></i> Barang</a
                >
                <a class="p-2 nav-link" href="kasir.html"
                  ><i class="bi bi-cart"></i> Kasir</a
                >
                <div class="nav-item dropdown">
                  <a
                    class="nav-link dropdown-toggle"
                    href="#"
                    id="navbarDropdownMenuLink"
                    role="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <i class="bi bi-person-fill"></i> Admin
                  </a>
                  <ul
                    class="dropdown-menu"
                    aria-labelledby="navbarDropdownMenuLink"
                  >
                    <li><a class="dropdown-item" href="#">User</a></li>
                    <li><hr class="dropdown-divider" /></li>
                    <li><a class="dropdown-item" href="#">Pemasukan</a></li>
                    <li><a class="dropdown-item" href="#">Pengeluaran</a></li>
                    <li><hr class="dropdown-divider" /></li>
                    <li><a class="dropdown-item" href="#">Master Data</a></li>
                    <li>
                      <a class="dropdown-item" href="#">Pengaturan Toko</a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </nav>
      </div>
    </div>

    <!-- Kasir Content -->
    <main class="container">
      <h2>Kasir</h2>
      <p>
        This is the cashier interface where items can be added to the cart and
        processed.
      </p>
      <div class="row g-5">
        <div class="col-md-8">
          <input class="form-control" type="search" placeholder="Cari Barang" />
          <table class="table mt-3">
            <thead>
              <tr>
                <th>Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="productList">
              <!-- Product list to add to cart -->
            </tbody>
          </table>
        </div>
        <div class="col-md-4">
          <div class="bg-light p-3">
            <h4>Cart</h4>
            <ul class="list-group" id="cartList">
              <!-- Cart items will be populated here -->
            </ul>
            <button class="btn btn-primary mt-3">Checkout</button>
          </div>
        </div>
      </div>
    </main>

    <!-- <script
      src="https://app.sandbox.midtrans.com/snap/snap.js"
      data-client-key="SB-Mid-client-ydrDEV5oNbZ3BxOu"
    ></script>
    <script>
      const express = require("express");
      const bodyParser = require("body-parser");
      const midtransClient = require("midtrans-client");

      const app = express();
      app.use(bodyParser.json());

      // Midtrans configuration
      const coreApi = new midtransClient.CoreApi({
        isProduction: false, // Sandbox mode
        serverKey: "SB-Mid-server-R4vQYYxyIircBc83__pxpor7",
        clientKey: "SB-Mid-client-ydrDEV5oNbZ3BxOu",
      });

      app.post("/create-transaction", async (req, res) => {
        const { order_id, gross_amount, items } = req.body;

        const parameter = {
          transaction_details: {
            order_id: order_id, // Unique ID for each transaction
            gross_amount: gross_amount, // Total payment
          },
          item_details: items, // Array of item objects
          customer_details: {
            first_name: "Customer",
            email: "customer@example.com",
          },
          enabled_payments: ["qris"], // Restrict to QRIS
        };

        try {
          const transaction = await coreApi.createTransaction(parameter);
          res.json({ token: transaction.token });
        } catch (error) {
          console.error(error);
          res.status(500).send("Transaction creation failed.");
        }
      });

      app.listen(3000, () => console.log("Server running on port 3000"));
    </script> -->

    <!-- fetch -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="SB-Mid-client-ydrDEV5oNbZ3BxOu"></script>
    <script type="module">
      document.addEventListener("DOMContentLoaded", function () {
        const selectedProducts =
          JSON.parse(localStorage.getItem("selectedProducts")) || [];
        const cartList = document.getElementById("cartList");
        const checkoutButton = document.querySelector(".btn-primary");
    
        // Render selected products in the cart
        selectedProducts.forEach((product) => {
          const listItem = document.createElement("li");
          listItem.className =
            "list-group-item d-flex justify-content-between align-items-center";
          listItem.innerHTML = `
            <div>
              <strong>${product.name || "Unknown Product"}</strong> <br>
              <small>Category: ${product.category || "Not Available"}</small> <br>
              <small>Description: ${product.description || "Not Available"}</small> <br>
              <small>Price: ${product.price || 0}</small> <br>
              <small>Quantity: ${product.quantity || 0}</small>
            </div>
            <span class="badge bg-primary rounded-pill">${product.quantity || 0}</span>
          `;
          cartList.appendChild(listItem);
        });
    
        // Function to get transaction token from backend
        async function getTransactionToken(orderDetails) {
          try {
            const response = await fetch("YOUR_BACKEND_URL/create-transaction", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(orderDetails),
            });
    
            if (!response.ok) {
              throw new Error("Failed to create transaction.");
            }
    
            const { token } = await response.json();
            return token;
          } catch (error) {
            console.error("Error fetching transaction token:", error);
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Failed to initiate payment. Please try again later.",
            });
            return null;
          }
        }
    
        // Function to update product stock via API
        async function updateProductStock(productId, quantityToReduce) {
          try {
            const response = await fetch(
              `https://pos-ochre.vercel.app/api/products/${productId}`
            );
            if (!response.ok)
              throw new Error(`Product with ID ${productId} not found.`);
    
            const productData = await response.json();
            const updatedStock = productData.stock - quantityToReduce;
    
            if (updatedStock < 0) {
              Swal.fire({
                icon: "error",
                title: "Insufficient Stock",
                text: `Not enough stock for ${productData.name}.`,
              });
              return false;
            }
    
            const updatedProduct = {
              name: productData.name,
              price: parseFloat(productData.price),
              category: productData.category,
              description: productData.description,
              stock: updatedStock,
            };
    
            const updateResponse = await fetch(
              `https://pos-ochre.vercel.app/api/products/${productId}`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedProduct),
              }
            );
    
            if (!updateResponse.ok) {
              throw new Error("Failed to update stock.");
            }
    
            return true;
          } catch (error) {
            console.error("Error updating stock:", error);
            Swal.fire({
              icon: "error",
              title: "Error",
              text: `Failed to update stock for product ID ${productId}. ${error.message}`,
            });
            return false;
          }
        }
    
        // Checkout button functionality
        checkoutButton.addEventListener("click", async function () {
          const orderDetails = {
            order_id: `ORDER-${Date.now()}`,
            gross_amount: 100000,
            item_details: [
              {
                id: "item01",
                price: 100000,
                quantity: 1,
                name: "Sample Product",
              },
            ],
            customer_details: {
              first_name: "John",
              last_name: "Doe",
              email: "johndoe@example.com",
            },
          };
        
          // Kirim request ke backend
          const response = await fetch("http://localhost:5000", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderDetails),
          });
        
          const data = await response.json();
          if (data.token) {
            // Panggil Snap pop-up dengan token
            window.snap.pay(data.token, {
              onSuccess: function (result) {
                console.log("Payment Success:", result);
                Swal.fire("Success", "Payment Completed!", "success");
              },
              onPending: function (result) {
                console.log("Payment Pending:", result);
                Swal.fire("Pending", "Waiting for payment completion.", "warning");
              },
              onError: function (result) {
                console.log("Payment Error:", result);
                Swal.fire("Error", "Payment Failed.", "error");
              },
            });
          } else {
            console.error("Failed to fetch transaction token.");
          }
        });
        
        });

    </script>
    
  </body>
</html>
